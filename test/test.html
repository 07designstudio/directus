<html>
 <head>
    <meta charset="utf-8"/>
    <title>Directus Tests</title>
    <link rel="stylesheet" href="../assets/bower/mocha/mocha.css"/>
 </head>
<body>
<div id="mocha"></div>

<script src="../assets/bower/requirejs/require.js"></script>

<script>
require.config({

  paths: {
    'mocha'       : '../assets/bower/mocha/mocha',
    'chai'        : '../assets/bower/chai/chai',
    'sinon'			  : '../assets/bower/sinon/lib/sinon',
    'chai-jquery' : '../assets/bower/chai-jquery/chai-jquery',
    'text' 			  : '../assets/bower/requirejs-text/text',
    'test'  		  : '../test',
    'jquery'      : '../assets/bower/jquery/jquery'
  },

  shim: {

  	'mocha': {
  		exports: 'mocha'
  	},

  	'sinon': {
  		exports: 'sinon'
  	},

    'chai-jquery': {
      deps: ['chai','jquery']
    }

  },

  baseUrl: "../app"

});

require(['config', 'chai', 'sinon', 'mocha', 'chai-jquery'], function(config, chai, sinon, mocha, chaiJQ) {

	require(['schema/SchemaManager', 'text!test/assets/schema/tables.json'], function(SchemaManager, tables) {


    // Localize or create a new JavaScript Template object.
    var JST = window.JST = window.JST || {};

    // Configure LayoutManager with Backbone Boilerplate defaults.
    Backbone.Layout.configure({
      // Allow LayoutManager to augment Backbone.View.prototype.
      manage: true,

      prefix: "app/templates/",


      fetchTemplate: function(path) {
        // Concatenate the file extension.

        // If template is not a path but instead Handlebars.Compile
        if (typeof path === 'function') {
          return path;
        }

        path = path + ".html";

        // If cached, use the compiled template.
        if (JST[path]) {
          return JST[path];
        }

        // Put fetch into `async-mode`.
        var done = this.async();

        // Seek out the template asynchronously.
        // ASYNC is causing render-order trouble, use sync now since it will be compiled anyway

        //$.get(app.root + path, function(contents) {
        //  done(JST[path] = Handlebars.compile(contents));
        //});


        $.ajax({
          url: '../' + path,
          global: false,
          async: false,
          success: function(contents) {
            done(JST[path] = Handlebars.compile(contents));
          }
        });
      }
    });


    // Setup a table schema for testing
    SchemaManager.setup({apiURL: 'test'});
    SchemaManager.register('tables', JSON.parse(tables));

    mocha.setup('bdd');

  	expect = chai.expect;
    chai.use(chaiJQ);

  	// Run tests
  	require([
  		'test/mocha/example.spec',
  		'test/mocha/directus/TableModel.spec',
      'test/mocha/directus/ColumnsCollection.spec',
      'test/mocha/directus/ColumnModel.spec',

      // UI's
      'test/mocha/directus/core-ui/one_to_many.spec',
      'test/mocha/directus/core-ui/many_to_one.spec',
      'test/mocha/directus/core-ui/many_to_many.spec',

      'test/mocha/directus/EntriesModel.spec'

  	], function() {
  		mocha.run();
  	});
  });
});

</script>

</body>
</html>